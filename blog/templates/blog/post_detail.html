{% extends 'blog/base.html' %}

{% load image_utils %}
{% load static %}

{% block title %}
  <title>{{ post.title }}</title>
{% endblock title %}

{% block meta_tags %}
  <meta name="description" content="{{ post.description }}">
  <meta name="keywords" content="{{ meta_keywords }}">
  <link rel="canonical" href="{{ request.scheme }}://{{ request.get_host }}{{ post.get_absolute_url }}">
  <meta property="og:title" content="{{ post.title }}">
  <meta property="og:description" content="{{ post.description }}">
  <meta property="og:type" content="article">
  <meta property="og:url" content="{{ request.scheme }}://{{ request.get_host }}{{ post.get_absolute_url }}">
  <meta property="og:image" content="{{ post.cover.url }}">
  <meta property="og:image:width" content="1280"/>
  <meta property="og:image:height" content="720"/>
  <meta property="og:site_name" content="Laboratório do Lyc">
  <meta property="article:published_time" content="{{ post.published_at|date:'c' }}" />
  <meta property="article:modified_time" content="{{ post.updated_at|date:'c' }}" />
  <meta property="article:section" content="{{ post.verbose_name|title }}" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="{{ post.title }}" />
  <meta name="twitter:description" content="{{ post.description }}" />
  <meta name="twitter:image" content="{{ post.cover.url }}" />
  {% for tag in post.tags.all %}
    <meta property="article:tag" content="{{ tag.name }}" />
  {% endfor %}
{% endblock meta_tags %}

{% block main %}
  <main class="container flex-fill">
    <div class="row">
      <div class="col-xl-9 bg-body-tertiary">
        <h1 class="pb-2 pt-2">{{ post.title }}</h1>
        <p>{{ post.description }}</p>
        <h6 class="pb-2">{{ post.created_at | date }}</h6>
        <div class="pb-3">
          <img
            class="img-fluid"
            style="aspect-ratio: 191/100; object-fit: cover;"
            src="{{ post.cover|variant:'large' }}"
            alt="{{ post.title }}"
          >
        </div>
        <div class="pt-3">
          {{ post.content | safe }}
        </div>
      </div>
      <div class="col-xl-3 mt-3" style="position: sticky; top: 1rem; height: fit-content;">
        {% if products %}
          <div class="row">
            <div id="product-carousel">
              {% for product in products %}
                <div class="mb-2 border border-2 border-light carousel-item fade-transition" style="display: none;">
                  <div class="card border-0 rounded-0 d-flex flex-row overflow-hidden h-100">            
                    <div class="flex-grow-1 position-relative">
                      <img class="product-main-img img-fluid w-100 h-100" 
                        src="{{ product.image|variant:'small' }}" 
                        alt="Product Image" 
                        style="aspect-ratio: 1/1; object-fit: cover; width: 300px; height: 300px;">
                    </div>
                    <div class="bg-light p-2 d-flex flex-column align-items-center justify-content-center gap-1 flex-shrink-0" 
                      style="min-width: 30px;">
                      {% for product_link in product.links.all %}
                        <a rel="sponsored nofollow" href="{{ product_link.url }}" target="_blank" class="opacity-100 transition">
                          <img src="{{ product_link.platform.logo.url }}" 
                            alt="Marketplace" 
                            style="width: 30px; height: auto; object-fit: contain;">
                        </a>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
            <div class="d-flex align-items-center justify-content-between px-3 mt-2 mb-3">
              <button id="prev-btn" class="carousel-nav-btn">
                &#10094; 
              </button>
              <div id="carousel-pips" class="d-flex justify-content-center gap-2">
              </div>
              <button id="next-btn" class="carousel-nav-btn">
                &#10095; 
              </button>
            </div>
          </div>
        {% endif %}
        {% if post.source_code %}
          <div class="pb-2">
            <a target="_blank" href="{{ post.source_code }}" 
              class="btn btn-lg w-100 d-flex justify-content-center align-items-center gap-1 text-decoration-none" 
              style="background-color: #24292e; color: #ffffff; border: none;">
              <i class="fs-3 fa-brands fa-github-alt"></i>
              Ver Código Fonte
            </a>
          </div>
        {% endif %}
        <div>
          {% if post.get_related_posts %}
            <h3 class="text-center">Posts relacionados</h3>
            <hr class="pb-2">
            {% for related_post in post.get_related_posts %}
              <a href="{% url 'post-detail' post_slug=related_post.slug %}" class="text-decoration-none text-reset">
                <div class="card border-0 rounded-4 pb-3">
                  <div style="position: relative;"> 
                    <img 
                      src="{{ related_post.cover|variant:'small' }}" 
                      class="card-img-top rounded-top-4" 
                      alt="{{ related_post.title }}"
                      style="aspect-ratio: 191/100; object-fit: cover;"
                    >
                    <span class="badge bg-primary rounded-4" style="
                      position: absolute; 
                      top: 10px; 
                      left: 10px; 
                      font-size: 0.85em;
                      z-index: 10;
                    ">
                      {{ related_post.verbose_name|title }} 
                    </span>
                    <span class="badge bg-primary rounded-4" style="
                      position: absolute; 
                      top: 10px; 
                      left: 10px; 
                      font-size: 0.85em;
                      z-index: 10;
                    ">
                      {{ related_post.verbose_name|title }} 
                    </span>
                  </div>
                  <div class="card-body bg-body-tertiary rounded-bottom-4">
                    <h5 class="card-title">{{ related_post.title }}</h5>
                  </div>
                </div>
              </a>
            {% endfor %}
          {% endif %}
        </div>
        <div class="pb-3">
          <h3 class="text-center">Descobrir mais</h3>
          <hr class="pb-2">
          <div class="d-flex justify-content-center flex-wrap gap-2">
            <a href="{% url 'posts-by-type' post_type=post.verbose_name_plural|slugify %}" 
              class="btn btn-sm btn-dark rounded-pill px-3">
              {{ post.verbose_name|title }}
            </a>
						{% for genre in post.get_genres_labels %}
							<a href="{% url 'posts-by-type' post_type=post.verbose_name_plural|slugify %}" 
								class="btn btn-sm btn-dark rounded-pill px-3">
								{{ genre }}
							</a>
						{% endfor %}
            {% for tag in post.tags.all %}
              <a href="{% url 'posts-by-tag' tag_slug=tag.slug %}" 
                class="btn btn-sm btn-outline-secondary rounded-pill px-3">
                {{ tag.name }}
              </a>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </main>
{% endblock main %}
